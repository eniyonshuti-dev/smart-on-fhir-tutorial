<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Diabetes Care Companion</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@latest/build/fhir-client.js"></script>
</head>
<body>
  <h1>Diabetes Care Companion</h1>
  <div id="status">Authorizing…</div>
  <div id="ctx"></div>
  <div id="labs"></div>

<script>
(async () => {
  try {
    // More robust storage handling on static hosts (GitHub Pages)
    FHIR.oauth2.settings.fullSessionStorageSupport = true;

    const client = await FHIR.oauth2.ready().catch(e => {
      document.getElementById("status").textContent =
        "Auth error: " + (e?.message || JSON.stringify(e));
      throw e;
    });

    // Show what was actually granted and which client was used
    const granted   = client.state?.tokenResponse?.scope || "(none)";
    const usedClient= client.state?.clientId || "(unknown)";
    const baseUrl   = client.state?.serverUrl || client.state?.tokenResponse?.iss || "";
    document.getElementById("status").textContent =
      `Granted scopes: ${granted} | clientId: ${usedClient} | iss: ${baseUrl}`;

    // Patient id from context (no Patient/{id} read)
    const pid =
      (client.getPatientId && client.getPatientId()) ||
      client.patient?.id ||
      client.state?.tokenResponse?.patient;

    document.getElementById("ctx").innerHTML =
      `<p><strong>Patient ID (context):</strong> ${pid || "(missing)"} </p>`;

    if (!pid) {
      document.getElementById("labs").innerHTML =
        "<p>Could not determine patient id from launch context.</p>";
      return;
    }

    // Helper: show friendly message on insufficient scope
    async function safeRequest(url) {
      try {
        return await client.request(url);
      } catch (e) {
        const msg = e?.response?.text || e?.message || JSON.stringify(e);
        document.getElementById("labs").innerHTML =
          `<p><strong>Data request failed.</strong> ${msg}
           <br/>This usually means the token lacks a data scope (e.g., <code>patient/*.read</code>).</p>`;
        throw e;
      }
    }

    // Latest HbA1c (LOINC 4548-4) using only a search
    const bundle = await safeRequest(
      `Observation?patient=${encodeURIComponent(pid)}&code=http://loinc.org|4548-4&_sort=-date&_count=1`
    );
    const a1c = bundle.entry?.[0]?.resource;

    document.getElementById("labs").innerHTML =
      a1c
        ? `<p><strong>Latest HbA1c:</strong> ${a1c.valueQuantity?.value ?? "—"} ${a1c.valueQuantity?.unit ?? ""} (${a1c.effectiveDateTime || a1c.issued || ""})</p>`
        : "<p>No HbA1c found for this patient.</p>";

  } catch (e) {
    console.error(e);
  }
})();
</script>
</body>
</html>
