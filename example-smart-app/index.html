<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Diabetes Care Companion</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient@latest/build/fhir-client.js"></script>
</head>
<body>
  <h1>Diabetes Care Companion</h1>
  <div id="status">Authorizing…</div>
  <div id="ctx"></div>
  <div id="labs"></div>

<script>
(async () => {
  try {
    FHIR.oauth2.settings.fullSessionStorageSupport = true;

    const client = await FHIR.oauth2.ready();

    const granted = client.state?.tokenResponse?.scope || "(none)";
    const usedClient = client.state?.clientId || "(unknown)";
    const iss = client.state?.serverUrl || client.state?.tokenResponse?.iss || "";
    document.getElementById("status").textContent =
      `Granted scopes: ${granted} | clientId: ${usedClient} | iss: ${iss}`;

    const pid =
      (client.getPatientId && client.getPatientId()) ||
      client.patient?.id ||
      client.state?.tokenResponse?.patient;

    document.getElementById("ctx").innerHTML =
      `<p><strong>Patient ID (context):</strong> ${pid || "(missing)"} </p>`;

    if (!pid) {
      document.getElementById("labs").innerHTML =
        "<p>Could not determine patient id from launch context.</p>";
      return;
    }

    // Only try the HbA1c call if the token actually has Observation.read
    if (!granted.includes("patient/Observation.read")) {
      document.getElementById("labs").innerHTML =
        "<p><em>Data not shown:</em> This token doesn’t include Observation read scope. " +
        "Provider apps in public sandboxes often get identity-only scopes unless approved.</p>";
      return;
    }

    // Latest HbA1c (LOINC 4548-4) using a search (no Patient/{id} read)
    const bundle = await client.request(
      `Observation?patient=${encodeURIComponent(pid)}&code=http://loinc.org|4548-4&_sort=-date&_count=1`
    );
    const a1c = bundle.entry?.[0]?.resource;

    document.getElementById("labs").innerHTML =
      a1c
        ? `<p><strong>Latest HbA1c:</strong> ${a1c.valueQuantity?.value ?? "—"} ${a1c.valueQuantity?.unit ?? ""} (${a1c.effectiveDateTime || a1c.issued || ""})</p>`
        : "<p>No HbA1c found for this patient.</p>";
  } catch (e) {
    document.getElementById("status").textContent =
      "Auth/Data error: " + (e?.message || JSON.stringify(e));
    console.error(e);
  }
})();
</script>
</body>
</html>
